##### Status: Complete #####
#
# Script Author: Ian the BitThirsty Hunter
# Creation Date: 20200103
#
# This script checks webpages via https and saves the titles of the pages
# Note Citrix ADC and Gateways both have "Citrix" or "Netscaler" in the page title (cve-2019-19781)
# As of Jan 3, 2020 the patch is only a manual fix: https://support.citrix.com/article/CTX267679
############################

######################
##### SSL Issues #####
######################
#SSL error, added from https://stackoverflow.com/questions/11696944/powershell-v3-invoke-webrequest-https-error
add-type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint srvPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
$AllProtocols = [System.Net.SecurityProtocolType]'Ssl3,Tls,Tls11,Tls12'
[System.Net.ServicePointManager]::SecurityProtocol = $AllProtocols
[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
#####

#####################
##### Main Code #####
#####################

#create our file
if(!(Test-Path -Path C:\Temp\Citrix_NetScalers_CVE-2019-19781.txt)){
    New-Item -Path C:\Temp -Name Citrix_NetScalers_CVE-2019-19781.txt -ItemType File
}

# Scan 10.200.12.x, 10.201.12.x, 10.202.164.x, 10.203.164.x
#Note with int arrays dont enclose with @()
$secondoctet = 200, 201, 202, 203
$thirdoctet = 22, 22, 174, 174

for ($i=0;$i -lt $secondoctet.Length; $i++) {
    1..255 | %{
    $IP = "10."+$secondoctet[$i]+"."+$thirdoctet[$i]+".$_"
    Write-Host $IP
        If (Test-Connection -count 1 -comp $IP -quiet) {
            $URL = "https://"+$IP
            $HTTP_Response = Invoke-WebRequest -UseDefaultCredentials -Uri $URL
            $HTTP_ResponseTable = @{}
            $HTTP_ResponseTable.title= $HTTP_Response.ParsedHtml.title
                        
            # We then get the HTTP code as an integer.
            $HTTP_Status = [int]$HTTP_Response.StatusCode

            # If successful save to file in C:\temp\Citrix_NetScalers_CVE-2019-19781.txt
            If ($HTTP_Status -eq 200) {
                Add-Content -Path C:\Temp\Citrix_NetScalers_CVE-2019-19781.txt -Value $IP
                Add-Content -Path C:\Temp\Citrix_NetScalers_CVE-2019-19781.txt -Value $HTTP_ResponseTable.title
                Write-Host "This was " + $IP
                Write-Host $HTTP_Response
            }
            Else {
    
            }
            #Reset HTTP variables
            $HTTP_Status = 0
            Remove-Variable HTTP_Response
        }
    }
}
